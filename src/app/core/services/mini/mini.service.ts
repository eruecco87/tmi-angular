import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';

// RXJS
import { Subject, Observable, of } from 'rxjs';
import { delay } from 'rxjs/operators';

// Environment
import { environment } from '@env/environment';

// Models
import { Mini } from '@core/services/mini/models';

@Injectable({
  providedIn: 'root'
})
export class MiniService {

  private endpoint = 'minis';

  public miniSelected$: Subject<Mini> = new Subject<Mini>();

  public mockGetAll: Mini[][] = [
    [{"id":10337,"name":"Gothic City: Cathedral Props (MONSTER MINIATURES II KICKSTARTER IS NOW LIVE)","status":1,"creator":{"name":"rocket_pig_games","id":1022},"thumbnail":"https://miniindex.blob.core.windows.net/images/10337.jpg","link":"https://www.myminifactory.com/object/3d-print-118154"},{"id":21514,"name":"Owlbear through the ages- 3.0/3.5 D&D","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21514.jpg","link":"https://www.thingiverse.com/thing:4387347"},{"id":21522,"name":"Molina (Cavalier Edition)","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/21522.jpg","link":"https://atelierstoria.com/collections/silver-wings/molina-cavalier"},{"id":21538,"name":"Justice - Blind Assassin","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/21538.jpg","link":"https://www.myminifactory.com/object/3d-print-justice-blind-assassin-145460"},{"id":9955,"name":"Dire Wolf","status":1,"creator":{"name":"mz4250","id":2},"thumbnail":"https://miniindex.blob.core.windows.net/images/9955.jpg","link":"https://www.shapeways.com/product/S324M3VL4/dire-wolf"},{"id":21510,"name":"Fluffy Raptor","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21510.jpg","link":"https://www.thingiverse.com/thing:4616966"},{"id":21110,"name":"Pirate Captain","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/21110.jpg","link":"https://www.myminifactory.com/object/3d-print-pirate-captain-142583"},{"id":21524,"name":"Elvira (Cavalier Edition)","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/21524.jpg","link":"https://atelierstoria.com/collections/silver-wings/elvira-cavalier"},{"id":21511,"name":"Owlbear through the ages- \"Chinasaur\": Prehistoric Animals Toy","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21511.jpg","link":"https://www.thingiverse.com/thing:4497393"},{"id":21082,"name":"Small campfire and logbench.","status":1,"creator":{"name":"3Dlayeredscenery","id":2283},"thumbnail":"https://miniindex.blob.core.windows.net/images/21082.jpg","link":"https://www.thingiverse.com/thing:3732400"},{"id":18950,"name":"Vampire Nosferatu","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/18950.jpg","link":"https://www.myminifactory.com/object/3d-print-vampire-nosferatu-139407"},{"id":12942,"name":"Undead Pirate Beast","status":1,"creator":{"name":"castnplay","id":1163},"thumbnail":"https://miniindex.blob.core.windows.net/images/12942.jpg","link":"https://gumroad.com/l/eXPAi"},{"id":11113,"name":"Aarakocra Monk","status":1,"creator":{"name":"RGSculpt","id":1196},"thumbnail":"https://miniindex.blob.core.windows.net/images/11113.jpg","link":"https://gumroad.com/l/uKRXe"},{"id":12284,"name":"Executioners set","status":1,"creator":{"name":"MysticPigeon","id":1983},"thumbnail":"https://miniindex.blob.core.windows.net/images/12284.jpg","link":"https://www.myminifactory.com/object/3d-print-executioners-set-127973"},{"id":20904,"name":"Dojo Diorama","status":1,"creator":{"name":"zymetheuy","id":2255},"thumbnail":"https://miniindex.blob.core.windows.net/images/20904.jpg","link":"https://www.myminifactory.com/object/3d-print-dojo-diorama-141232"},{"id":11600,"name":"octopus","status":1,"creator":{"name":"exclusive3dprints","id":1321},"thumbnail":"https://miniindex.blob.core.windows.net/images/11600.jpg","link":"https://www.thingiverse.com/thing:3691195"},{"id":21161,"name":"Old Cottage","status":1,"creator":{"name":"narnaa","id":2293},"thumbnail":"https://miniindex.blob.core.windows.net/images/21161.jpg","link":"https://www.thingiverse.com/thing:4662707"},{"id":15711,"name":"Hoplite-1","status":1,"creator":{"name":"clynche","id":1632},"thumbnail":"https://miniindex.blob.core.windows.net/images/15711.jpg","link":"https://www.myminifactory.com/object/3d-print-hoplite-1-130785"},{"id":13637,"name":"Hydra","status":1,"creator":{"name":"rocket_pig_games","id":1022},"thumbnail":"https://miniindex.blob.core.windows.net/images/13637.jpg","link":"https://www.myminifactory.com/object/3d-print-hydra-111777"},{"id":9861,"name":"Heroes of Sandpoint: Ao","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/9861.jpg","link":"https://gumroad.com/l/as0008-heroes-of-sandpoint-ao"},{"id":18948,"name":"Armored Dwarf","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/18948.jpg","link":"https://www.myminifactory.com/object/3d-print-armored-dwarf-139851"}],
    [{"id":10337,"name":"Gothic City: Cathedral Props (MONSTER MINIATURES II KICKSTARTER IS NOW LIVE)","status":1,"creator":{"name":"rocket_pig_games","id":1022},"thumbnail":"https://miniindex.blob.core.windows.net/images/10337.jpg","link":"https://www.myminifactory.com/object/3d-print-118154"},{"id":21514,"name":"Owlbear through the ages- 3.0/3.5 D&D","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21514.jpg","link":"https://www.thingiverse.com/thing:4387347"},{"id":21522,"name":"Molina (Cavalier Edition)","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/21522.jpg","link":"https://atelierstoria.com/collections/silver-wings/molina-cavalier"},{"id":21538,"name":"Justice - Blind Assassin","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/21538.jpg","link":"https://www.myminifactory.com/object/3d-print-justice-blind-assassin-145460"},{"id":9955,"name":"Dire Wolf","status":1,"creator":{"name":"mz4250","id":2},"thumbnail":"https://miniindex.blob.core.windows.net/images/9955.jpg","link":"https://www.shapeways.com/product/S324M3VL4/dire-wolf"},{"id":21510,"name":"Fluffy Raptor","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21510.jpg","link":"https://www.thingiverse.com/thing:4616966"},{"id":21110,"name":"Pirate Captain","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/21110.jpg","link":"https://www.myminifactory.com/object/3d-print-pirate-captain-142583"},{"id":21524,"name":"Elvira (Cavalier Edition)","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/21524.jpg","link":"https://atelierstoria.com/collections/silver-wings/elvira-cavalier"},{"id":21511,"name":"Owlbear through the ages- \"Chinasaur\": Prehistoric Animals Toy","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21511.jpg","link":"https://www.thingiverse.com/thing:4497393"},{"id":21082,"name":"Small campfire and logbench.","status":1,"creator":{"name":"3Dlayeredscenery","id":2283},"thumbnail":"https://miniindex.blob.core.windows.net/images/21082.jpg","link":"https://www.thingiverse.com/thing:3732400"},{"id":18950,"name":"Vampire Nosferatu","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/18950.jpg","link":"https://www.myminifactory.com/object/3d-print-vampire-nosferatu-139407"},{"id":12942,"name":"Undead Pirate Beast","status":1,"creator":{"name":"castnplay","id":1163},"thumbnail":"https://miniindex.blob.core.windows.net/images/12942.jpg","link":"https://gumroad.com/l/eXPAi"},{"id":11113,"name":"Aarakocra Monk","status":1,"creator":{"name":"RGSculpt","id":1196},"thumbnail":"https://miniindex.blob.core.windows.net/images/11113.jpg","link":"https://gumroad.com/l/uKRXe"},{"id":12284,"name":"Executioners set","status":1,"creator":{"name":"MysticPigeon","id":1983},"thumbnail":"https://miniindex.blob.core.windows.net/images/12284.jpg","link":"https://www.myminifactory.com/object/3d-print-executioners-set-127973"},{"id":20904,"name":"Dojo Diorama","status":1,"creator":{"name":"zymetheuy","id":2255},"thumbnail":"https://miniindex.blob.core.windows.net/images/20904.jpg","link":"https://www.myminifactory.com/object/3d-print-dojo-diorama-141232"},{"id":11600,"name":"octopus","status":1,"creator":{"name":"exclusive3dprints","id":1321},"thumbnail":"https://miniindex.blob.core.windows.net/images/11600.jpg","link":"https://www.thingiverse.com/thing:3691195"},{"id":21161,"name":"Old Cottage","status":1,"creator":{"name":"narnaa","id":2293},"thumbnail":"https://miniindex.blob.core.windows.net/images/21161.jpg","link":"https://www.thingiverse.com/thing:4662707"},{"id":15711,"name":"Hoplite-1","status":1,"creator":{"name":"clynche","id":1632},"thumbnail":"https://miniindex.blob.core.windows.net/images/15711.jpg","link":"https://www.myminifactory.com/object/3d-print-hoplite-1-130785"},{"id":13637,"name":"Hydra","status":1,"creator":{"name":"rocket_pig_games","id":1022},"thumbnail":"https://miniindex.blob.core.windows.net/images/13637.jpg","link":"https://www.myminifactory.com/object/3d-print-hydra-111777"},{"id":9861,"name":"Heroes of Sandpoint: Ao","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/9861.jpg","link":"https://gumroad.com/l/as0008-heroes-of-sandpoint-ao"},{"id":18948,"name":"Armored Dwarf","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/18948.jpg","link":"https://www.myminifactory.com/object/3d-print-armored-dwarf-139851"}],
    [{"id":10337,"name":"Gothic City: Cathedral Props (MONSTER MINIATURES II KICKSTARTER IS NOW LIVE)","status":1,"creator":{"name":"rocket_pig_games","id":1022},"thumbnail":"https://miniindex.blob.core.windows.net/images/10337.jpg","link":"https://www.myminifactory.com/object/3d-print-118154"},{"id":21514,"name":"Owlbear through the ages- 3.0/3.5 D&D","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21514.jpg","link":"https://www.thingiverse.com/thing:4387347"},{"id":21522,"name":"Molina (Cavalier Edition)","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/21522.jpg","link":"https://atelierstoria.com/collections/silver-wings/molina-cavalier"},{"id":21538,"name":"Justice - Blind Assassin","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/21538.jpg","link":"https://www.myminifactory.com/object/3d-print-justice-blind-assassin-145460"},{"id":9955,"name":"Dire Wolf","status":1,"creator":{"name":"mz4250","id":2},"thumbnail":"https://miniindex.blob.core.windows.net/images/9955.jpg","link":"https://www.shapeways.com/product/S324M3VL4/dire-wolf"},{"id":21510,"name":"Fluffy Raptor","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21510.jpg","link":"https://www.thingiverse.com/thing:4616966"},{"id":21110,"name":"Pirate Captain","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/21110.jpg","link":"https://www.myminifactory.com/object/3d-print-pirate-captain-142583"},{"id":21524,"name":"Elvira (Cavalier Edition)","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/21524.jpg","link":"https://atelierstoria.com/collections/silver-wings/elvira-cavalier"},{"id":21511,"name":"Owlbear through the ages- \"Chinasaur\": Prehistoric Animals Toy","status":1,"creator":{"name":"StormCrow13","id":2033},"thumbnail":"https://miniindex.blob.core.windows.net/images/21511.jpg","link":"https://www.thingiverse.com/thing:4497393"},{"id":21082,"name":"Small campfire and logbench.","status":1,"creator":{"name":"3Dlayeredscenery","id":2283},"thumbnail":"https://miniindex.blob.core.windows.net/images/21082.jpg","link":"https://www.thingiverse.com/thing:3732400"},{"id":18950,"name":"Vampire Nosferatu","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/18950.jpg","link":"https://www.myminifactory.com/object/3d-print-vampire-nosferatu-139407"},{"id":12942,"name":"Undead Pirate Beast","status":1,"creator":{"name":"castnplay","id":1163},"thumbnail":"https://miniindex.blob.core.windows.net/images/12942.jpg","link":"https://gumroad.com/l/eXPAi"},{"id":11113,"name":"Aarakocra Monk","status":1,"creator":{"name":"RGSculpt","id":1196},"thumbnail":"https://miniindex.blob.core.windows.net/images/11113.jpg","link":"https://gumroad.com/l/uKRXe"},{"id":12284,"name":"Executioners set","status":1,"creator":{"name":"MysticPigeon","id":1983},"thumbnail":"https://miniindex.blob.core.windows.net/images/12284.jpg","link":"https://www.myminifactory.com/object/3d-print-executioners-set-127973"},{"id":20904,"name":"Dojo Diorama","status":1,"creator":{"name":"zymetheuy","id":2255},"thumbnail":"https://miniindex.blob.core.windows.net/images/20904.jpg","link":"https://www.myminifactory.com/object/3d-print-dojo-diorama-141232"},{"id":11600,"name":"octopus","status":1,"creator":{"name":"exclusive3dprints","id":1321},"thumbnail":"https://miniindex.blob.core.windows.net/images/11600.jpg","link":"https://www.thingiverse.com/thing:3691195"},{"id":21161,"name":"Old Cottage","status":1,"creator":{"name":"narnaa","id":2293},"thumbnail":"https://miniindex.blob.core.windows.net/images/21161.jpg","link":"https://www.thingiverse.com/thing:4662707"},{"id":15711,"name":"Hoplite-1","status":1,"creator":{"name":"clynche","id":1632},"thumbnail":"https://miniindex.blob.core.windows.net/images/15711.jpg","link":"https://www.myminifactory.com/object/3d-print-hoplite-1-130785"},{"id":13637,"name":"Hydra","status":1,"creator":{"name":"rocket_pig_games","id":1022},"thumbnail":"https://miniindex.blob.core.windows.net/images/13637.jpg","link":"https://www.myminifactory.com/object/3d-print-hydra-111777"},{"id":9861,"name":"Heroes of Sandpoint: Ao","status":1,"creator":{"name":"atelierstoria","id":1374},"thumbnail":"https://miniindex.blob.core.windows.net/images/9861.jpg","link":"https://gumroad.com/l/as0008-heroes-of-sandpoint-ao"},{"id":18948,"name":"Armored Dwarf","status":1,"creator":{"name":"YourNeighborKnight","id":1623},"thumbnail":"https://miniindex.blob.core.windows.net/images/18948.jpg","link":"https://www.myminifactory.com/object/3d-print-armored-dwarf-139851"}]
  ]

  public mockGetById: Mini = {"id":10337,"name":"Gothic City: Cathedral Props (MONSTER MINIATURES II KICKSTARTER IS NOW LIVE)","status":0,"thumbnail":"https://miniindex.blob.core.windows.net/images/10337.jpg","link":"https://www.myminifactory.com/object/3d-print-118154","creator":{"name":"rocket_pig_games","id":1022},"tags":[{"tagName":"Building","category":3,"status":1},{"tagName":"gothic","category":13,"status":1},{"tagName":"Scatter","category":3,"status":1},{"tagName":"Fantasy","category":2,"status":1},{"tagName":"Historical","category":2,"status":1},{"tagName":"cathedral","category":null,"status":1}],"relatedMinis":[{"id":13637,"name":"Hydra","thumbnail":"https://miniindex.blob.core.windows.net/images/13637.jpg","link":"https://www.myminifactory.com/object/3d-print-hydra-111777","creator":{"name":"rocket_pig_games","id":1022}},{"id":13230,"name":"Gothic City: Streets Core Set (MONSTER MINIATURES II KICKSTARTER IS NOW LIVE)","thumbnail":"https://miniindex.blob.core.windows.net/images/13230.jpg","link":"https://www.myminifactory.com/object/3d-print-gothic-city-streets-core-set-118098","creator":{"name":"rocket_pig_games","id":1022}},{"id":13080,"name":"Banshee","thumbnail":"https://miniindex.blob.core.windows.net/images/13080.jpg","link":"https://www.myminifactory.com/object/3d-print-banshee-120073","creator":{"name":"rocket_pig_games","id":1022}},{"id":13125,"name":"Worm Walker","thumbnail":"https://miniindex.blob.core.windows.net/images/13125.jpg","link":"https://www.myminifactory.com/object/3d-print-worm-walker-120054","creator":{"name":"rocket_pig_games","id":1022}},{"id":13653,"name":"Brain Golem","thumbnail":"https://miniindex.blob.core.windows.net/images/13653.jpg","link":"https://www.myminifactory.com/object/3d-print-brain-golem-110054","creator":{"name":"rocket_pig_games","id":1022}}]};

  constructor(
    private httpClient: HttpClient
  ) { }

  public getAll(pageIndex: number): Observable<Mini[]> {

    if (environment.api.enableMocks) {

      return of(this.mockGetAll[pageIndex - 1]).pipe(
        delay(environment.api.mockDelay)
      );

    }

    return this.httpClient.get<Mini[]>(`${ environment.api.url }/${ this.endpoint }/search`, {
      params: {
        pageIndex: encodeURIComponent(pageIndex)
      }
    });

  }

  public getById(id: string): Observable<Mini> {

    if (environment.api.enableMocks) {

      return of(this.mockGetById).pipe(
        delay(environment.api.mockDelay)
      );

    }

    return this.httpClient.get<Mini>(`${ environment.api.url }/${ this.endpoint }/view`, {
      params: {
        id: encodeURIComponent(id)
      }
    });

  }

  public getSourceSite(link: string): string {

    const URL_PARTS = link
      .replace("http://", "")
      .replace("https://", "")
      .split(/[/?#]/)[0]
      .split(".");

    return URL_PARTS[URL_PARTS.length - 2];

  }
}
